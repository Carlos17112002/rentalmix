<!DOCTYPE html>
{% load humanize %}
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detalle de Camión</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f5f5f5;
    }
    .container {
      max-width: 960px;
      margin-top: 2rem;
    }
    .card {
      margin-bottom: 2rem;
    }
    .table th, .table td {
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="container">
  <a href="{% url 'dashboard_camiones' %}" class="btn btn-secondary mb-3">← Volver al listado de camiones</a>

  {% if camion %}
    <!-- Datos del camión -->
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Camión {{ camion.patente }}</h4>
      </div>
      <div class="card-body">
        <p><strong>Marca:</strong> {{ camion.marca }}</p>
        <p><strong>Modelo:</strong> {{ camion.modelo }}</p>
        <p><strong>Año:</strong> {{ camion.año }}</p>
        <p><strong>Capacidad:</strong> {{ camion.capacidad_kg }} kg</p>
        <p><strong>Estado:</strong> {{ camion.estado|title }}</p>
        <p><strong>Observaciones:</strong> {{ camion.observaciones|default:"Sin observaciones" }}</p>
      </div>
    </div>

    <!-- Botón para nuevo contrato -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Contratos Asociados</h5>
      <a href="{% url 'crear_contrato' camion.id %}" class="btn btn-success">➕ Nuevo Contrato</a>
    </div>

    <!-- Lista de contratos -->
    {% if contratos %}
      <div class="list-group">
        {% for contrato in contratos %}
          <a href="{% url 'detalle_contrato' contrato.id %}" class="list-group-item list-group-item-action">
            <strong>Contrato #{{ contrato.id }}</strong> — {{ contrato.nombre }}<br>
            <small>Vigencia: {{ contrato.fecha_inicio }} a {{ contrato.fecha_termino }}</small>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info">Este camión no tiene contratos registrados.</div>
    {% endif %}

  {% else %}
    <div class="alert alert-warning">Camión no encontrado.</div>
  {% endif %}
</div>

  <script>
    function calcularTotales() {
      const get = name => parseFloat(document.querySelector(`[name="${name}"]`)?.value || 0);

      const presente = get("presente_estado_pago");
      const devolucion = get("devolucion_anticipo");
      const multas = get("descuentos_multas");
      const seguro = get("devolucion_seguro");
      const descuento_pct = get("descuento_especial");
      const retencion = get("retencion");

      const subtotal = presente - devolucion - multas + seguro;
      const subtotal_desc = subtotal - (subtotal * descuento_pct / 100);
      const iva = subtotal_desc * 0.19;
      const total_estado = subtotal_desc + iva;
      const total_pagar = total_estado - retencion;

      document.getElementById("subtotal").value = subtotal.toLocaleString("es-CL");
      document.getElementById("subtotal_desc").value = subtotal_desc.toLocaleString("es-CL");
      document.getElementById("iva").value = iva.toLocaleString("es-CL");
      document.getElementById("total_estado").value = total_estado.toLocaleString("es-CL");
      document.getElementById("total_pagar").value = total_pagar.toLocaleString("es-CL");
    }

    document.querySelectorAll(".calc").forEach(input => {
      input.addEventListener("input", calcularTotales);
    });

    window.addEventListener("DOMContentLoaded", calcularTotales);
  </script>
</body>
</html>