<!DOCTYPE html>
{% load humanize %}
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detalle de Camión</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f5f5f5;
    }
    .container {
      max-width: 960px;
      margin-top: 2rem;
    }
    .card {
      margin-bottom: 2rem;
    }
    .table th, .table td {
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="{% url 'dashboard_camiones' %}" class="btn btn-secondary mb-3">← Volver al listado de camiones</a>

    {% if camion %}
      <!-- Datos del camión -->
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Camión {{ camion.patente }}</h4>
        </div>
        <div class="card-body">
          <p><strong>Marca:</strong> {{ camion.marca }}</p>
          <p><strong>Modelo:</strong> {{ camion.modelo }}</p>
          <p><strong>Año:</strong> {{ camion.año }}</p>
          <p><strong>Capacidad:</strong> {{ camion.capacidad_kg }} kg</p>
          <p><strong>Estado:</strong> {{ camion.estado|title }}</p>
          <p><strong>Observaciones:</strong> {{ camion.observaciones|default:"Sin observaciones" }}</p>
        </div>
      </div>

      <!-- Tabla de estados de pago -->
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">Estados de Pago Registrados</h5>
        </div>
        <div class="card-body p-0">
          <table class="table table-bordered table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th>Periodo</th>
                <th>Presente</th>
                <th>Devolución</th>
                <th>Multas</th>
                <th>Seguro</th>
                <th>Subtotal</th>
                <th>Desc. %</th>
                <th>Subtotal con Desc.</th>
                <th>IVA</th>
                <th>Total Estado</th>
                <th>Retención</th>
                <th>Total a Pagar</th>
              </tr>
            </thead>
            <tbody>
              {% for e in estados %}
                <tr>
                  <td>{{ e.periodo }}</td>
                  <td>${{ e.presente_estado_pago|intcomma }}</td>
                  <td>${{ e.devolucion_anticipo|intcomma }}</td>
                  <td>${{ e.descuentos_multas|intcomma }}</td>
                  <td>${{ e.devolucion_seguro|intcomma }}</td>
                  <td>${{ e.subtotal|intcomma }}</td>
                  <td>{{ e.descuento_especial }}%</td>
                  <td>${{ e.subtotal_con_descuento|intcomma }}</td>
                  <td>${{ e.iva|intcomma }}</td>
                  <td>${{ e.total_estado_pago|intcomma }}</td>
                  <td>${{ e.retencion|intcomma }}</td>
                  <td><strong>${{ e.total_a_pagar|intcomma }}</strong></td>
                </tr>
              {% empty %}
                <tr><td colspan="12" class="text-center">Sin estados registrados.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Formulario editable de estado de pago -->
      <h4 class="mt-5">Registrar Nuevo Estado de Pago</h4>
      <form method="post">
        {% csrf_token %}
        <table class="table table-bordered table-sm align-middle">
          <tbody>
            <tr><th>Periodo</th><td><input type="text" name="periodo" class="form-control" required></td></tr>
            <tr><th>Presente Estado de Pago</th><td><input type="number" name="presente_estado_pago" class="form-control calc" value="0"></td></tr>
            <tr><th>Devolución de Anticipo</th><td><input type="number" name="devolucion_anticipo" class="form-control calc" value="0"></td></tr>
            <tr><th>Descuentos o Multas</th><td><input type="number" name="descuentos_multas" class="form-control calc" value="0"></td></tr>
            <tr><th>Devolución Seguro</th><td><input type="number" name="devolucion_seguro" class="form-control calc" value="0"></td></tr>
            <tr><th>Descuento Especial (%)</th><td><input type="number" name="descuento_especial" class="form-control calc" value="0" step="0.01"></td></tr>
            <tr><th>Retención</th><td><input type="number" name="retencion" class="form-control calc" value="0"></td></tr>
            <tr><th>Subtotal</th><td><input type="text" id="subtotal" class="form-control" readonly></td></tr>
            <tr><th>Subtotal con Descuento</th><td><input type="text" id="subtotal_desc" class="form-control" readonly></td></tr>
            <tr><th>IVA (19%)</th><td><input type="text" id="iva" class="form-control" readonly></td></tr>
            <tr><th>Total Estado de Pago</th><td><input type="text" id="total_estado" class="form-control" readonly></td></tr>
            <tr class="table-success"><th>Total a Pagar</th><td><input type="text" id="total_pagar" class="form-control fw-bold" readonly></td></tr>
          </tbody>
        </table>
        <button type="submit" class="btn btn-primary">Guardar Estado de Pago</button>
      </form>

    {% else %}
      <div class="alert alert-warning">Camión no encontrado.</div>
    {% endif %}
  </div>

  <script>
    function calcularTotales() {
      const get = name => parseFloat(document.querySelector(`[name="${name}"]`)?.value || 0);

      const presente = get("presente_estado_pago");
      const devolucion = get("devolucion_anticipo");
      const multas = get("descuentos_multas");
      const seguro = get("devolucion_seguro");
      const descuento_pct = get("descuento_especial");
      const retencion = get("retencion");

      const subtotal = presente - devolucion - multas + seguro;
      const subtotal_desc = subtotal - (subtotal * descuento_pct / 100);
      const iva = subtotal_desc * 0.19;
      const total_estado = subtotal_desc + iva;
      const total_pagar = total_estado - retencion;

      document.getElementById("subtotal").value = subtotal.toLocaleString("es-CL");
      document.getElementById("subtotal_desc").value = subtotal_desc.toLocaleString("es-CL");
      document.getElementById("iva").value = iva.toLocaleString("es-CL");
      document.getElementById("total_estado").value = total_estado.toLocaleString("es-CL");
      document.getElementById("total_pagar").value = total_pagar.toLocaleString("es-CL");
    }

    document.querySelectorAll(".calc").forEach(input => {
      input.addEventListener("input", calcularTotales);
    });

    window.addEventListener("DOMContentLoaded", calcularTotales);
  </script>
</body>
</html>