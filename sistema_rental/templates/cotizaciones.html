{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cotización</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>

    .titulo-cotizacion {
      font-size: 34px; /* antes 42px */
      font-weight: 700;
      background-color: #ffffff;
      border: 2px solid #0d6efd;
      padding: 10px 20px;
      border-radius: 8px;
      display: inline-block;
      color: #0d6efd;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 30px; /* separa del logo */
    }
    body { background-color: #f9f9f9; padding: 30px; font-size: 18px; }
    h1 { text-align: center; margin-bottom: 30px; }
    label { font-weight: bold; margin-top: 15px; }
    input, select, textarea { font-size: 18px; }
    .table th, .table td { vertical-align: middle; text-align: center; }
    .totales { font-weight: bold; text-align: right; }
    .btn-lg { font-size: 18px; padding: 10px 20px; }
    .preview { background-color: #fff; border: 1px solid #ccc; padding: 20px; margin-top: 30px; }
    @media print { .no-print { display: none; } }
  </style>
</head>
<body>

  <div class="text-center mb-4 d-flex flex-column align-items-center">
    <img src="{% static 'img/logo.png' %}" alt="Logo" style="height: 100px; width: auto;">
    <h1 class="titulo-cotizacion">Cotización</h1>
  </div>
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <div class="d-flex flex-wrap gap-2">
    <a href="{% url 'crear_producto' %}" class="btn btn-success btn-lg no-print">+ Nuevo Producto</a>
    <a href="{% url 'listado_cotizaciones' %}" class="btn btn-warning btn-lg no-print" style="color: white;">Listado de Cotizaciones</a>
  </div>
  <a href="{% url 'menu_rental' %}" class="btn btn-outline-dark btn-lg no-print">⬅️ Volver al Menú</a>
</div>
  <form class="no-print">
    <div class="row mb-3">
      <div class="col-md-6 position-relative">
        <label for="producto">Producto</label>
        <input type="text" id="producto" class="form-control" placeholder="Escribe para buscar producto..." autocomplete="off">
        <ul id="sugerencias" class="list-group position-absolute w-100" style="z-index: 1000;"></ul>
      </div>
      <div class="col-md-6">
        <label for="codigo">Código</label>
        <input type="text" id="codigo" class="form-control" oninput="buscarPorCodigo()">
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-4">
        <label for="precio">Precio Unitario</label>
        <input type="number" id="precio" class="form-control" readonly>
      </div>
      <div class="col-md-4">
        <label for="iva">IVA (%)</label>
        <input type="number" id="iva" class="form-control" value="19" onchange="actualizarCalculo()">
      </div>
      <div class="col-md-4">
        <label for="cantidad">Cantidad</label>
        <input type="number" id="cantidad" class="form-control" value="1" min="1" onchange="actualizarCalculo()">
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-4">
        <label>Neto</label>
        <input type="text" id="subtotal" class="form-control" readonly>
      </div>
      <div class="col-md-4">
        <label>IVA</label>
        <input type="text" id="monto_iva" class="form-control" readonly>
      </div>
      <div class="col-md-4">
        <label>Total con IVA</label>
        <input type="text" id="total" class="form-control" readonly>
      </div>
    </div>

    <div class="text-end">
      <button type="button" class="btn btn-primary btn-lg" id="btnAgregar">Agregar al detalle</button>
    </div>
  </form>

  <table class="table table-bordered mt-4">
    <thead class="table-light">
      <tr>
        <th>Producto</th>
        <th>Código</th>
        <th>Precio Unitario</th>
        <th>Cantidad</th>
        <th>Subtotal</th>
        <th>IVA</th>
        <th>Total</th>
        <th class="no-print">Acción</th>
      </tr>
    </thead>
    <tbody id="detalle"></tbody>
    <tfoot>
      <tr><td colspan="4" class="totales">Neto:</td><td colspan="4" id="total_sin_iva">$0.00</td></tr>
      <tr><td colspan="4" class="totales">IVA:</td><td colspan="4" id="total_iva">$0.00</td></tr>
      <tr><td colspan="4" class="totales">Total:</td><td colspan="4" id="total_con_iva">$0.00</td></tr>
    </tfoot>
  </table>

  <label class="mt-4">Observaciones</label>
  <textarea class="form-control no-print" rows="3" placeholder="Notas para la cotización..." id="observaciones"></textarea>

  <div class="text-end no-print mt-4">
    <button onclick="window.print()" class="btn btn-success btn-lg">Imprimir Cotización</button>
    <button type="button" class="btn btn-warning btn-lg" onclick="guardarCotizacion()">Guardar Cotización</button>
  </div>

  <div class="preview">
    <h4>Vista previa rápida</h4>
    <p class="d-flex align-items-center gap-2 mb-3">
      <img src="{% static 'img/logo.png' %}" alt="Logo" style="height: 32px;">
      <span class="mb-0">- Cotización rápida</span>
    </p>
    <p>Neto: <span id="preview_sin_iva">$0.00</span></p>
    <p>IVA: <span id="preview_iva">$0.00</span></p>
    <p>Total: <span id="preview_total">$0.00</span></p>
  </div>

  <script>
    let productoSeleccionado = null;
  const productosData = {
    {% for producto in productos %}
      "{{ producto.codigo }}": {
        descripcion: "{{ producto.descripcion|escapejs }}",
        precio: {{ producto.precio_costo_unitario|floatformat:0 }}
      },
    {% endfor %}
    {% for producto in productos_nuevos %}
      "{{ producto.codigo }}": {
        descripcion: "{{ producto.descripcion|escapejs }}",
        precio: {{ producto.precio_costo_unitario|floatformat:0 }}
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  };

  function actualizarProductoDesdeSelect() {
    const select = document.getElementById('producto');
    const codigo = select.value;
    const producto = productosData[codigo];
    if (producto) {
      document.getElementById('codigo').value = codigo;
      document.getElementById('precio').value = producto.precio;
      actualizarCalculo();
    }
  }

  function buscarPorCodigo() {
    const codigo = document.getElementById('codigo').value.trim();
    const producto = productosData[codigo];
    if (producto) {
      document.getElementById('producto').value = codigo;
      document.getElementById('precio').value = producto.precio;
      actualizarCalculo();
    }
  }

  function actualizarCalculo() {
    const precio = parseFloat(document.getElementById('precio').value) || 0;
    const cantidad = parseFloat(document.getElementById('cantidad').value) || 1;
    const iva = parseFloat(document.getElementById('iva').value) || 0;
    const subtotal = precio * cantidad;
    const montoIVA = subtotal * (iva / 100);
    const total = subtotal + montoIVA;

    document.getElementById('subtotal').value = `$${formatearCLP(subtotal)}`;
    document.getElementById('monto_iva').value = `$${formatearCLP(montoIVA)}`;
    document.getElementById('total').value = `$${formatearCLP(total)}`;
  }

  function agregarProducto() {
  const codigo = document.getElementById('codigo').value.trim();
  const cantidad = parseFloat(document.getElementById('cantidad').value);
  const iva = parseFloat(document.getElementById('iva').value);
  const producto = productoSeleccionado;

  if (!producto || !codigo || !cantidad) {
    alert("Completa los datos correctamente.");
    return;
  }

  const subtotal = producto.precio * cantidad;
  const montoIVA = subtotal * (iva / 100);
  const total = subtotal + montoIVA;

  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${producto.descripcion}</td>
    <td>${codigo}</td>
    <td>$${formatearCLP(producto.precio)}</td>
    <td>${cantidad}</td>
    <td>$${formatearCLP(subtotal)}</td>
    <td>$${formatearCLP(montoIVA)}</td>
    <td>$${formatearCLP(total)}</td>
    <td class="no-print">
      <button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); actualizarTotales()">Eliminar</button>
    </td>
  `;
  document.getElementById('detalle').appendChild(row);
  actualizarTotales();
  limpiarCampos();
}

  function limpiarCampos() {
  productoSeleccionado = null;
  document.getElementById('producto').value = "";
  document.getElementById('codigo').value = "";
  document.getElementById('precio').value = "";
  document.getElementById('cantidad').value = 1;
  document.getElementById('subtotal').value = "";
  document.getElementById('monto_iva').value = "";
  document.getElementById('total').value = "";
}

  function limpiarNumero(texto) {
    return parseFloat(texto.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
  }

  function formatearCLP(valor) {
    return valor.toLocaleString('es-CL', {
      style: 'decimal',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
  }

  function actualizarTotales() {
    let neto = 0;
    let ivaTotal = 0;
    document.querySelectorAll('#detalle tr').forEach(row => {
      const subtotal = limpiarNumero(row.cells[4].textContent);
      const iva = limpiarNumero(row.cells[5].textContent);
      neto += subtotal;
      ivaTotal += iva;
    });
    const totalFinal = neto + ivaTotal;

    document.getElementById('total_sin_iva').textContent = `$${formatearCLP(neto)}`;
    document.getElementById('total_iva').textContent = `$${formatearCLP(ivaTotal)}`;
    document.getElementById('total_con_iva').textContent = `$${formatearCLP(totalFinal)}`;

    document.getElementById('preview_sin_iva').textContent = `$${formatearCLP(neto)}`;
    document.getElementById('preview_iva').textContent = `$${formatearCLP(ivaTotal)}`;
    document.getElementById('preview_total').textContent = `$${formatearCLP(totalFinal)}`;
  }

  function getCSRFToken() {
    return document.cookie.split('; ')
      .find(row => row.startsWith('csrftoken='))
      ?.split('=')[1];
  }

  function guardarCotizacion() {
    const observaciones = document.getElementById('observaciones').value;
    const productos = [];

    document.querySelectorAll('#detalle tr').forEach(row => {
      const producto = row.cells[0].textContent;
      const codigo = row.cells[1].textContent;
      const precio = limpiarNumero(row.cells[2].textContent);
      const cantidad = parseFloat(row.cells[3].textContent);
      const subtotal = limpiarNumero(row.cells[4].textContent);
      const iva = limpiarNumero(row.cells[5].textContent);
      const total = limpiarNumero(row.cells[6].textContent);

      productos.push({ producto, codigo, precio, cantidad, subtotal, iva, total });
    });

    const cotizacion = {
      observaciones,
      productos,
      neto: limpiarNumero(document.getElementById('total_sin_iva').textContent),
      iva: limpiarNumero(document.getElementById('total_iva').textContent),
      total: limpiarNumero(document.getElementById('total_con_iva').textContent)
    };

    fetch("{% url 'guardar_cotizacion' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify(cotizacion)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("Cotización guardada correctamente.");
        window.location.href = "{% url 'listado_cotizaciones' %}";
      } else {
        alert("Error al guardar la cotización.");
      }
    })
    .catch(error => {
      alert("Error de conexión al guardar la cotización.");
      console.error(error);
    });
  }

  window.onload = () => {
    actualizarTotales();
    document.getElementById('producto').addEventListener('change', actualizarProductoDesdeSelect);
    document.getElementById('codigo').addEventListener('input', buscarPorCodigo);
    document.getElementById('cantidad').addEventListener('change', actualizarCalculo);
    document.getElementById('iva').addEventListener('change', actualizarCalculo);
    document.getElementById('btnAgregar').addEventListener('click', agregarProducto);
  };
</script>
<script>
  const inputProducto = document.getElementById('producto');
  const sugerencias = document.getElementById('sugerencias');

  function filtrarProductosAjax() {
    const texto = inputProducto.value.trim();
    sugerencias.innerHTML = '';

    if (texto.length < 2) return;

    fetch(`/menu/ajax/buscar-productos/?q=${encodeURIComponent(texto)}`)
      .then(res => res.json())
      .then(data => {
        data.forEach(p => {
          const item = document.createElement('li');
          item.className = 'list-group-item list-group-item-action';
          item.textContent = `[${p.codigo}] ${p.descripcion}`;
          item.onclick = () => seleccionarProducto(p);
          sugerencias.appendChild(item);
        });
      })
      .catch(err => console.error("Error al buscar productos:", err));
  }

  function seleccionarProducto(p) {
  productoSeleccionado = p;
  inputProducto.value = `[${p.codigo}] ${p.descripcion}`;
  document.getElementById('codigo').value = p.codigo;
  document.getElementById('precio').value = p.precio;
  sugerencias.innerHTML = '';
  actualizarCalculo();
}
  

  inputProducto.addEventListener('input', filtrarProductosAjax);

  document.addEventListener('click', e => {
    if (!sugerencias.contains(e.target) && e.target !== inputProducto) {
      sugerencias.innerHTML = '';
    }
  });
</script>
</body>
</html>