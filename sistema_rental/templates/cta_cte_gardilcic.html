{% load static %}
{% load formatos %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Cuenta Corriente Gardilcic</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
</head>
<body>
<div class="container py-4">
  <header class="mb-4">
    <h1 class="display-5">Cuenta Corriente Gardilcic</h1>
    <a href="{% url 'menu_rental' %}" class="btn btn-outline-secondary">← Volver al menú</a>
  </header>

  <!-- ================== REGISTRAR COMPRA ================== -->
  <section class="mt-5">
    <h2 class="h4">Registrar Arriendo</h2>
    <form method="post" class="mb-4">
      {% csrf_token %}
      <input type="hidden" name="tipo" value="compra">
      <div class="form-row">
        <div class="col-md-2 mb-2">
          <select name="mes" class="form-control" required>
            <option value="">Mes</option>
            {% for m in meses %}
              <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 mb-2"><input type="date" name="fecha" class="form-control" required></div>
        <div class="col-md-2 mb-2"><input type="text" name="factura" placeholder="N° Factura" class="form-control" required></div>
        <div class="col-md-2 mb-2"><input type="number" name="total" placeholder="Total" class="form-control" required></div>
        <div class="col-md-4 mb-2"><input type="text" name="mensaje" placeholder="Mensaje" class="form-control"></div>
      </div>
      <div class="form-row">
        <div class="col-md-2 mb-2"><input type="number" name="pagado" placeholder="Monto pagado" class="form-control"></div>
        <div class="col-md-2 mb-2"><input type="date" name="fecha_pago" class="form-control"></div>
        <div class="col-md-2 mb-2">
          <select name="estado" class="form-control">
            <option value="Pendiente">Pendiente</option>
            <option value="Pagado">Pagado</option>
            <option value="Vencido">Vencido</option>
          </select>
        </div>
        <div class="col-md-2 mb-2">
          <button type="submit" class="btn btn-primary btn-block">Guardar</button>
        </div>
      </div>
    </form>

    <!-- ================== LISTADO DE COMPRAS ================== -->
    <h3 class="h5">Listado General</h3>
    <table class="table table-bordered table-sm">
      <thead class="thead-light">
        <tr>
          <th>#</th><th>Mes</th><th>Fecha</th><th>Factura</th><th>Total</th><th>Mensaje</th>
          <th>Pagado</th><th>Fecha de Pago</th><th>Estado</th><th>Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for c in compras %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ c.mes }}</td>
            <td>{{ c.fecha }}</td>
            <td>{{ c.factura }}</td>
            <td>${{ c.total|formato_chileno }}</td>
            <td>{{ c.mensaje }}</td>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="tipo" value="editar_compra">
              <input type="hidden" name="compra_id" value="{{ c.id }}">
              <td>
                <div class="d-flex align-items-center">
                  <input type="number" name="pagado" value="{{ c.pagado }}" class="form-control form-control-sm mr-2" style="width: 100px;">
                  <span class="text-muted">${{ c.pagado|formato_chileno|floatformat:0 }}</span>
                </div>
              </td>
              <td><input type="date" name="fecha_pago" value="{{ c.fecha_pago|date:'Y-m-d' }}" class="form-control form-control-sm"></td>
              <td>
                <select name="estado" class="form-control form-control-sm">
                  <option value="Pendiente" {% if c.estado == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                  <option value="Pagado" {% if c.estado == 'Pagado' %}selected{% endif %}>Pagado</option>
                  <option value="Vencido" {% if c.estado == 'Vencido' %}selected{% endif %}>Vencido</option>
                </select>
              </td>
              <td><button type="submit" class="btn btn-sm btn-success">Actualizar</button></td>
            </form>
          </tr>
        {% empty %}
          <tr><td colspan="10" class="text-center">No hay registros.</td></tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="4" class="text-right">Total:</th>
          <th colspan="6">${{ total_compras|formato_chileno }}</th>
        </tr>
      </tfoot>
    </table>
  </section>

  <!-- ================== VENTAS AGRUPADAS ================== -->
  <section class="mt-5">
    <h2 class="h4">Ventas</h2>
    <table class="table table-bordered table-sm">
      <thead class="thead-light">
        <tr><th>#</th><th>Mes</th><th>Total Ventas</th></tr>
      </thead>
      <tbody>
        {% for v in ventas %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ v.mes }}</td>
            <td>${{ v.total|formato_chileno }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3" class="text-center">No hay ventas registradas.</td></tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="2" class="text-right">Total Ventas:</th>
          <th>${{ total_compras|formato_chileno }}</th>
        </tr>
      </tfoot>
    </table>
  </section>

 <!-- ================== PAGOS AGRUPADOS ================== -->
<section class="mt-5">
  <h2 class="h4">Pagos</h2>
  <table class="table table-bordered table-sm">
    <thead class="thead-light">
      <tr><th>#</th><th>Mes</th><th>Pagado</th><th>Debe</th></tr>
    </thead>
    <tbody>
      {% for r in resumen_por_mes %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ r.mes }}</td>
          <td>${{ r.pagado|formato_chileno }}</td>
          <td>${{ r.deuda|formato_chileno }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="4" class="text-center">No hay pagos registrados.</td></tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="2" class="text-right">Total Pagado:</th>
        <th>${{ total_pagado|formato_chileno }}</th>
        <th>${{ total_deuda|formato_chileno }}</th>
      </tr>
    </tfoot>
  </table>
</section>
</div>
</body>
</html>